# Client Script runs only on the client
# KrunkScript Copyright (C) Yendis Entertainment Pty Ltd
# 

obj commandMenu_config = {
	menuKey: "o",           # Key used to open menu
	buttons: obj[],
	ui: {              		# Styling used for UI
		menu: {
			paddingPx: 5,
			
			width: 25, 		
			widthIsPercent: true,
			height: 30,  	
			heightIsPercent: true,
			
			backgroundColor: "#333333",
            opacity: 1,
        	textColor: "#ffffff",
			position: { 	# Uses widthIsPercent/heightIsPercent to determine whether or not these are a % per px
				top: 50, 
				left: 50
			},
			additional: "border-radius:5px;"
		},
		header: {
			text: "Player List",
			width: 100, 		
			widthIsPercent: true,
			height: 10, 	
			heightIsPercent: true,
			
        	textColor: "#ffffff",
		},
		row: {
			width: 98, 		
			widthIsPercent: true,
			
			height: 25, 	
			heightIsPercent: false,
			
            opacity: 1,
        	textColor: "#ffffff",
        	rowOddColor: "#5d5d5d",
        	rowEvenColor: "#838383",
			additional: "margin: 0 auto;padding:0.5% 0%;"
		},
		button: {
			width:8,
			widthIsPercent: true,
			height: 95, 	
			heightIsPercent: true,
			opacity: 1,
			textColor: "#dddddd",
			additional: "display:flex;float:right;font-size:8px;align-items:center;justify-content:center;margin:0px 5px 0px;border-radius:5px;border: 1px solid #333333"
		},
		playerText: {
			width: 48,
			widthIsPercent: true,
			height: 100,
			heightIsPercent: true,
			
			textColor: "#ffffff",
			additional: "text-align:left;float:left;margin-left:2%"
		}
    },    
    commandDivId: "commandDiv"
};

obj commandMenu_menuState = {
    enabled: false,
	created: false,
    players: obj[] # Can likely remove
};

str action commandMenu_sizeUnit(bool isPercent) {
	return isPercent ? "%" : "px";
}

str action commandMenu_createStyle(obj style) {
	
	str cssStyle = "";
	
	# Margin
	if(toNum style.marginPx > 0) {
		cssStyle += "margin:" + toStr style.marginPx + "px;";
	}
	# Padding
	if(toNum style.paddingPx > 0) {
		cssStyle += "padding:" + toStr style.paddingPx + "px;";
	}
	
    # Width/Height
    cssStyle += "width:" + (str)style.width + commandMenu_sizeUnit((bool)style.widthIsPercent) + ";height:" + (str)style.height + commandMenu_sizeUnit((bool)style.heightIsPercent) + ";";

    # Background color + opacity
	if(!!style.backgroundColor) {
    	cssStyle += "background-color:" + (str)style.backgroundColor + ";opacity:" + (str)style.opacity + ";";
	}

	# Text color
	if(!!style.textColor) {
		cssStyle += "color:" + (str)style.textColor + ";";	
	}

    # Position, if defined
    if(notEmpty (obj)style.position) {
        # Center based on width/height
        num top = (num)style.position.top - (num)style.height / 2;
        num left = (num)style.position.left - (num)style.width / 2;

        cssStyle += "position:fixed;top:" + toStr top + commandMenu_sizeUnit((bool)style.heightIsPercent) + ";" + "left:" + toStr left + commandMenu_sizeUnit((bool)style.widthIsPercent) + ";";
    }

    if(!!style.additional) {
        cssStyle += (str)style.additional;
    }

    return cssStyle;
}

action commandMenu_generateMenu() {
    commandMenu_menuState.players = GAME.PLAYERS.list();
	commandMenu_menuState.created = true;

    GAME.UI.addDIV((str)commandMenu_config.commandDivId, true, commandMenu_createStyle((obj)commandMenu_config.ui.menu));

	# Create header
	str headerDiv = GAME.UI.addDIV("commandHeader", true, commandMenu_createStyle((obj)commandMenu_config.ui.header), (str)commandMenu_config.commandDivId);
	GAME.UI.updateDIVText(headerDiv, commandMenu_config.ui.header.text);

	# Create body container
	str bodyDiv = GAME.UI.addDIV("commandBody", true, "width:100%;height:" + toStr(100 - (num)commandMenu_config.ui.header.height) +"%;overflow-y:auto;", (str)commandMenu_config.commandDivId);

	# Create rows
	for(num i = 0; i < lengthOf commandMenu_menuState.players; i++) {
		obj player = (obj)commandMenu_menuState.players[i];
		
		#num sid = (num)commandMenu_menuState.players[i].sid;
		num sid = i;
		
		str idPostfix = "_" + toStr sid + "_" + (str)player.username;
		
		# Create row
		commandMenu_config.ui.row.backgroundColor = (i + 1) % 2 == 0 ? (str)commandMenu_config.ui.row.rowEvenColor : (str)commandMenu_config.ui.row.rowOddColor; # Alternates background color where first row is odd
		
    	str rowId = GAME.UI.addDIV("playerRow_" + toStr sid, true, commandMenu_createStyle((obj)commandMenu_config.ui.row), bodyDiv);
	
		# Create username text
    	str textId = GAME.UI.addDIV("playerText_" + toStr sid, true, commandMenu_createStyle((obj)commandMenu_config.ui.playerText), rowId);
		GAME.UI.updateDIVText(textId, commandMenu_menuState.players[i].username);

		# Create buttons
		for(num z = 0; z < lengthOf commandMenu_config.buttons; z++) {
			obj button = (obj)commandMenu_config.buttons[z];

			# Skip any commands that can't be executed on yourself
			if(!button.executeOnSelf && (bool)player.isYou) {
				continue;
			}

			if((bool)button.isSeparator) {
				if((num)button.width > 0) {
					GAME.UI.addDIV("seperator_" + toStr z + idPostfix, true, "width:" + toStr button.width + "%;height:100%;float:right", rowId);
			}

			continue;
		}

		commandMenu_config.ui.button.backgroundColor = button.color;

		GAME.UI.updateDIVText(
		GAME.UI.addDIV((str)button.name + idPostfix, true, commandMenu_createStyle((obj)commandMenu_config.ui.button), rowId), 
		button.name);

		}
	}
}

action commandMenu_showMenu() {
    if(!commandMenu_menuState.enabled) {
        return;
    }

    GAME.INPUTS.unlockMouse();

    commandMenu_generateMenu();
}

action commandMenu_hideMenu() {
    GAME.UI.removeDIV((str)commandMenu_config.commandDivId);
	commandMenu_menuState.created = false;
}

obj action commandMenu_parseDivId(str id) {
	#name_sid_username
	
	obj parsedDiv = {
		method: "",
		sid: 0,
		username: ""
	};
	
	str[] split = str[];
	str temp = "";
	
	for(num i = 0; i < lengthOf id; i++) {
		if((str)id[i] == "_") {
			addTo split temp;
			temp = "";
			
			continue;
		}
		
		temp += id[i];
	}
	
	if(lengthOf temp > 0) {
		addTo split temp;
	}
	
	if(lengthOf split == 3) {
		parsedDiv.method = split[0];
		parsedDiv.sid = toNum split[1];
		parsedDiv.username = split[2];
	}
	
	
	return parsedDiv;
}

action commandMenu_handleKeyPress(str key) {
    if((str)commandMenu_config.menuKey == key) {
        if(!commandMenu_menuState.visible) {
            commandMenu_showMenu();
        }
    }
}

action commandMenu_handleDivClicked(str id) {
	obj parsedDiv = commandMenu_parseDivId(id);

	for(num i = 0; i < lengthOf commandMenu_config.buttons; i++) {
		if((bool)commandMenu_config.buttons[i].isSeparator) {
			continue;
		}
		
		if((str)commandMenu_config.buttons[i].name == (str)parsedDiv.method) {
			
			# Send network message
			GAME.NETWORK.send("executeCommand", parsedDiv);
		
			return;
		}
	}
}

action commandMenu_handleNetworkMessage(str id, obj data) {
    # Server enables menu
    if(id == "commandMenu") {
        commandMenu_menuState.enabled = true;
		
		for(num i = 0; i < lengthOf data.buttons; i++) {
			addTo commandMenu_config.buttons data.buttons[i];
		}
    }
}

# Might be another way to detect when clicking off the menu
action commandMenu_handleMouseClick() {
	if((bool)commandMenu_menuState.created) {
        commandMenu_hideMenu();
	}
}

# Game Hooks

public action onKeyPress(str key, num code) {
    commandMenu_handleKeyPress(key);
}

public action onDIVClicked(str id) {
    commandMenu_handleDivClicked(id);
}

public action onNetworkMessage(str id, obj data) {
    commandMenu_handleNetworkMessage(id, data);
}

public action onMouseClick(num button, num x, num y) {
    commandMenu_handleMouseClick();
}
